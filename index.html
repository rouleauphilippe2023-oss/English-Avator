<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Avatar ‚Äî Assistant IA</title>
  <meta name="description" content="Apprends l'anglais avec un assistant IA qui r√©pond √† haute voix." />
  <style>
    :root{
      --bg:#f7fafc;          /* clair */
      --panel:#ffffff;       /* cartes */
      --text:#111827;        /* gris-900 */
      --muted:#6b7280;       /* gris-500 */
      --primary:#2563eb;     /* bleu */
      --primary-2:#60a5fa;   /* bleu clair */
      --me:#1d4ed8;          /* bulle utilisateur */
      --bot:#eef2ff;         /* bulle bot */
      --border:#e5e7eb;
      --ok:#059669;          /* vert */
      --err:#dc2626;         /* rouge */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      background: var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .container{ width:min(960px,100%); }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
      overflow:hidden;
    }
    header{
      padding:18px 20px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:14px;
    }
    .logo{width:42px;height:42px;border-radius:10px;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      display:grid;place-items:center;color:#fff;font-weight:700}
    header h1{font-size:18px;margin:0}
    header p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .chat{height:min(62vh,640px); overflow:auto; padding:18px 20px; scroll-behavior:smooth; background:#fafafa}
    .bubble{
      max-width:78%; padding:12px 14px; border-radius:14px; line-height:1.45;
      margin:10px 0; white-space:pre-wrap; word-wrap:break-word; border:1px solid var(--border);
    }
    .me{background:var(--me); color:#fff; margin-left:auto; border-bottom-right-radius:6px; border-color:transparent;}
    .bot{background:var(--bot); color:var(--text); border-bottom-left-radius:6px;}
    .row{
      display:flex; gap:10px; align-items:center; padding:14px; border-top:1px solid var(--border);
      background:#fff;
    }
    .row input{
      flex:1; background:#fff; color:var(--text); border:1px solid var(--border);
      padding:12px 14px; border-radius:12px; outline:none;
    }
    .btn{
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      color:#fff; border:none; padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .tool{
      background:#fff; color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .tool.active{border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.18) inset}
    .meta{display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-top:1px solid var(--border); background:#fff}
    .muted{color:var(--muted); font-size:12px}
    .select{
      background:#fff; color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:8px 10px;
    }
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="logo">EA</div>
        <div>
          <h1>English Avatar ¬∑ Assistant IA</h1>
          <p>Pose une question en anglais ‚Äî je r√©ponds √† haute voix üéß</p>
        </div>
      </header>

      <div id="chat" class="chat" aria-live="polite"></div>

      <div class="row">
        <button id="micBtn" class="tool" title="Dicter (micro)">üéôÔ∏è</button>
        <input id="prompt" type="text" placeholder="√âcris (ou dicte) ta question en anglais‚Ä¶" autocomplete="off" />
        <button id="sendBtn" class="btn">Envoyer ‚û§</button>
      </div>

      <div class="meta">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="speakToggle" class="tool">üîä Voix : ON</button>
          <select id="voiceSelect" class="select" title="Choisir la voix (anglais)">
            <option>Chargement des voix‚Ä¶</option>
          </select>
        </div>
        <span class="muted">API : <code id="apiUrlLabel"></code></span>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_URL = "https://english-avator-u31q.vercel.app/api/chat"; // backend Vercel confirm√©
    document.getElementById('apiUrlLabel').textContent = API_URL;

    // ===== UI =====
    const chat = document.getElementById('chat');
    const promptInput = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const speakToggle = document.getElementById('speakToggle');
    const voiceSelect = document.getElementById('voiceSelect');

    let speakingEnabled = true;
    let currentVoice = null;
    let recognizing = false;

    function addBubble(text, who="bot"){
      const b = document.createElement('div');
      b.className = 'bubble ' + (who === 'me' ? 'me' : 'bot');
      b.textContent = text;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
      return b;
    }

    // ===== TTS (voix) =====
    function loadVoicesAndSelect(){
      if(!('speechSynthesis' in window)) return;
      const voices = window.speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      // privil√©gier des voix en anglais pour apprendre
      const english = voices.filter(v => /^en(-|_|$)/i.test(v.lang));
      const list = english.length ? english : voices;
      if(list.length === 0){
        const opt = document.createElement('option');
        opt.textContent = "Aucune voix trouv√©e";
        voiceSelect.appendChild(opt);
        return;
      }
      list.forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
      currentVoice = list[0];
      voiceSelect.selectedIndex = 0;
    }
    if ('speechSynthesis' in window) {
      loadVoicesAndSelect();
      window.speechSynthesis.onvoiceschanged = loadVoicesAndSelect;
    }

    function speak(text){
      if(!speakingEnabled || !('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      if (currentVoice) u.voice = currentVoice;
      u.rate = 1.0; u.pitch = 1.0; u.lang = currentVoice?.lang || 'en-US';
      try { window.speechSynthesis.cancel(); } catch(e){}
      window.speechSynthesis.speak(u);
    }

    voiceSelect.addEventListener('change', () => {
      const voices = window.speechSynthesis.getVoices();
      const english = voices.filter(v => /^en(-|_|$)/i.test(v.lang));
      const list = english.length ? english : voices;
      currentVoice = list[voiceSelect.selectedIndex] || null;
    });
    speakToggle.addEventListener('click', () => {
      speakingEnabled = !speakingEnabled;
      speakToggle.textContent = speakingEnabled ? "üîä Voix : ON" : "üîá Voix : OFF";
    });

    // ===== Reconnaissance vocale =====
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognizer = SR ? new SR() : null;
    if(recognizer){
      recognizer.lang = 'en-US';
      recognizer.interimResults = false;
      recognizer.maxAlternatives = 1;
      recognizer.addEventListener('result', e => {
        const text = e.results[0][0].transcript;
        promptInput.value = text;
        sendMessage();
      });
      recognizer.addEventListener('end', () => {
        recognizing = false;
        micBtn.classList.remove('active');
      });
      micBtn.addEventListener('click', () => {
        if(recognizing){ recognizer.stop(); return; }
        try { recognizer.start(); recognizing = true; micBtn.classList.add('active'); } catch(e){}
      });
    } else {
      micBtn.title = "Reconnaissance vocale non disponible dans ce navigateur";
      micBtn.style.opacity = .6;
    }

    // ===== Chat =====
    async function sendMessage(){
      const text = promptInput.value.trim();
      if(!text) return;
      promptInput.value = "";
      sendBtn.disabled = true;

      addBubble(text, "me");
      const thinking = addBubble("‚Ä¶", "bot");

      try{
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ prompt: text })
        });
        if(!res.ok) throw new Error(`API HTTP ${res.status}`);
        const data = await res.json().catch(()=> ({}));
        const reply = data.reply || data.message || data.text || "I‚Äôm here! (no text returned)";
        thinking.textContent = reply;
        speak(reply);
      }catch(err){
        console.error(err);
        thinking.innerHTML = "‚ùå <span style='color:var(--err)'>Erreur API : impossible d‚Äôobtenir la r√©ponse IA.</span>";
      }finally{
        sendBtn.disabled = false;
        chat.scrollTop = chat.scrollHeight;
      }
    }
    sendBtn.addEventListener('click', sendMessage);
    promptInput.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });

    // Message d‚Äôaccueil
    addBubble("Hi! I‚Äôm your English learning assistant. Ask me anything and I‚Äôll answer out loud. üéôÔ∏è", "bot");
    speak("Hi! I‚Äôm your English learning assistant. Ask me anything and I will answer out loud.");
  </script>
</body>
</html>
